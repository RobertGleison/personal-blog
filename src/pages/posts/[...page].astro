---
import BaseLayout from '../../layouts/BaseLayout.astro';
import ArticleCard from '../../components/ArticleCard.astro';
import SearchBar from '../../components/SearchBar.astro';
import Pagination from '../../components/Pagination.astro';
import CategoriesSidebar from '../../components/CategoriesSidebar.astro';

export async function getStaticPaths({ paginate }: any) {
    const allPosts = await Astro.glob('./*.md');
    const sortedPosts = allPosts.filter(post => post.frontmatter?.pubDate)
                                .sort((a, b) => {
                                    return new Date(b.frontmatter.pubDate).getTime() - new Date(a.frontmatter.pubDate).getTime();
                                });

    return paginate(sortedPosts, { pageSize: 8 });
}

const { page } = Astro.props;
const allPosts = await Astro.glob('./*.md');

// Set number of posts per category
const allCategoryMap = new Map<string, number>();
  allPosts.forEach(post => {
      const tags = post.frontmatter.tags || [];
      tags.forEach((tag: string) => {
          allCategoryMap.set(tag, (allCategoryMap.get(tag) || 0) + 1);
      });
});

// Get all posts for total category count
const categories = Array.from(allCategoryMap.entries())
    .map(([name, count]) => ({ name, count }))
    .sort((a, b) => {
      // Sort by count descending, then by name ascending for stable ordering
      if (b.count !== a.count) {
          return b.count - a.count;
      }
      return a.name.localeCompare(b.name);
});
---

<BaseLayout title={`Posts - Page ${page.currentPage} | Robert Gleison`} description="Technical articles and reflections about programming and teconolgy.">

    <div class="posts-page-container">
        <div class="posts-page-header">
            <h1>Posts</h1>
            <p class="posts-subtitle">Technical articles and reflections about programming and teconolgy.</p>
            <SearchBar />
        </div>

      <div class="posts-layout">
          <CategoriesSidebar categories={categories} totalPosts={allPosts.length} />

          <div class="posts-main-content">
            <div class="articles-grid">
                {page.data.map((post: any) => (
                    <ArticleCard
                        url={post.url || ''}
                        title={post.frontmatter.title}
                        description={post.frontmatter.description}
                        pubDate={new Date(post.frontmatter.pubDate)}
                        author={post.frontmatter.author}
                        image={post.frontmatter.image}
                        tags={post.frontmatter.tags}
                    />
                ))}
            </div>

            <Pagination
                currentPage={page.currentPage}
                totalPages={page.lastPage}
                baseUrl="/posts/"
            />
        </div>
      </div>
    </div>
</BaseLayout>

<style>
  .posts-page-container {
    max-width: 1400px;
    margin: 0 auto;
    padding: 2rem;
  }

  .posts-page-header {
    margin-bottom: 2rem;
  }

  .posts-page-header h1 {
    font-size: 2.5rem;
    font-weight: bold;
    color: var(--text-primary);
    margin-bottom: 0.5rem;
  }

  .tag-name {
    color: var(--accent-color);
  }

  .posts-subtitle {
    font-size: 1rem;
    color: var(--text-secondary);
    margin-bottom: 2rem;
  }

  .posts-layout {
    display: grid;
    grid-template-columns: 280px 1fr;
    gap: 3rem;
    align-items: start;
  }

  .posts-main-content {
    min-width: 0;
  }

  .articles-grid {
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
    margin-bottom: 3rem;
  }

  @media (max-width: 968px) {
    .posts-layout {
      grid-template-columns: 1fr;
      gap: 2rem;
    }
  }

  @media (max-width: 768px) {
    .posts-page-container {
      padding: 1rem;
    }

    .posts-page-header h1 {
      font-size: 2rem;
    }

    .posts-subtitle {
      font-size: 0.9rem;
    }

    .articles-grid {
      grid-template-columns: 1fr;
      gap: 1.5rem;
    }
  }
</style>
