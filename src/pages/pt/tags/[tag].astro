---
import { getCollection } from 'astro:content';
import BaseLayout from '../../../layouts/BaseLayout.astro';
import ArticleCard from '../../../components/ArticleCard.astro';
import { translate } from '../../../i18n/utils';

const locale = 'pt';

export async function getStaticPaths() {
  const allPosts = await getCollection('posts', ({ id }) => id.startsWith('pt/'));

  const allTags = new Set<string>();
  allPosts.forEach(post => {
    post.data.tags?.forEach((tag: string) => allTags.add(tag.toLowerCase()));
  });

  return Array.from(allTags).map(tag => ({
    params: { tag },
    props: { tag },
  }));
}

const { tag } = Astro.props;

const allPosts = await getCollection('posts', ({ id }) => id.startsWith('pt/'));
const filteredPosts = allPosts.filter(post =>
  post.data.tags?.some((translate: string) => translate.toLowerCase() === tag.toLowerCase())
).sort((a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf());

// Get display name (with proper casing)
const displayTag = filteredPosts[0]?.data.tags?.find(
  (translate: string) => translate.toLowerCase() === tag.toLowerCase()
) || tag;
---

<BaseLayout title={`${displayTag} | Robert Gleison`} description={`Posts marcados com ${displayTag}`} locale={locale}>

    <div class="posts-page-container">
        <div class="posts-page-header">
            <a href={`/${locale}/posts/`} class="back-link">&larr; {translate(locale, 'posts.allPosts')}</a>
            <h1>
              <span class="tag-label">Tag:</span>
              <span class="tag-name">{displayTag}</span>
            </h1>
            <p class="posts-subtitle">{filteredPosts.length} post{filteredPosts.length !== 1 ? 's' : ''}</p>
        </div>

        <div class="articles-grid">
            {filteredPosts.map((post) => (
                <ArticleCard
                    url={`/${locale}/posts/${post.slug.replace('pt/', '')}/`}
                    title={post.data.title}
                    description={post.data.description}
                    pubDate={post.data.pubDate}
                    author={post.data.author}
                    image={post.data.image}
                    tags={post.data.tags}
                    locale={locale}
                />
            ))}
        </div>
    </div>
</BaseLayout>

<style>
  .posts-page-container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 2rem;
  }

  .posts-page-header {
    margin-bottom: 2rem;
  }

  .back-link {
    display: inline-block;
    color: var(--text-muted);
    text-decoration: none;
    margin-bottom: 1rem;
    transition: color 0.2s;
  }

  .back-link:hover {
    color: var(--accent-color);
  }

  .posts-page-header h1 {
    font-size: 2.5rem;
    font-weight: bold;
    color: var(--text-primary);
    margin-bottom: 0.5rem;
  }

  .tag-label {
    font-weight: 300;
    color: var(--text-muted);
  }

  .tag-name {
    color: var(--accent-color);
  }

  .posts-subtitle {
    font-size: 1rem;
    color: var(--text-secondary);
  }

  .articles-grid {
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
  }

  @media (max-width: 768px) {
    .posts-page-container {
      padding: 1rem;
    }

    .posts-page-header h1 {
      font-size: 2rem;
    }
  }
</style>
