---
import { getCollection } from 'astro:content';
import BaseLayout from '../../../layouts/BaseLayout.astro';
import ArticleCard from '../../../components/ArticleCard.astro';
import SearchBar from '../../../components/SearchBar.astro';
import Pagination from '../../../components/Pagination.astro';
import { translate } from '../../../i18n/utils';
import { locales, type Locale } from '../../../i18n/config';

export async function getStaticPaths({ paginate }: { paginate: Function }) {
  const paths = [];

  for (const locale of locales) {
    const allPosts = await getCollection('posts', ({ id }) => id.startsWith(`${locale}/`));
    const sortedPosts = allPosts.sort((a, b) =>
      b.data.pubDate.valueOf() - a.data.pubDate.valueOf()
    );

    const allCategoryMap = new Map<string, number>();
    allPosts.forEach(post => {
      const tags = post.data.tags || [];
      tags.forEach((tag: string) => {
        allCategoryMap.set(tag, (allCategoryMap.get(tag) || 0) + 1);
      });
    });

    const categories = Array.from(allCategoryMap.entries())
      .map(([name, count]) => ({ name, count }))
      .sort((a, b) => {
        if (b.count !== a.count) {
          return b.count - a.count;
        }
        return a.name.localeCompare(b.name);
      });

    const paginated = paginate(sortedPosts, {
      params: { locale },
      pageSize: 10,
      props: { categories, totalPosts: allPosts.length },
    });

    paths.push(...paginated);
  }

  return paths;
}

const locale = Astro.params.locale as Locale;
const { page } = Astro.props;
const { categories, totalPosts } = Astro.props;
---

<BaseLayout title={`${translate(locale, 'posts.title')} | Robert Gleison`} description={translate(locale, 'posts.subtitle')} locale={locale}>

    <div class="posts-page-container">
        <div class="posts-page-header">
            <h1>{translate(locale, 'posts.title')}</h1>
            <p class="posts-subtitle">{translate(locale, 'posts.subtitle')}</p>
        </div>

      <SearchBar locale={locale} />

      <div class="posts-layout">
          <aside class="categories-sidebar">
            <h3>{translate(locale, 'categories.title')}</h3>
            <ul class="category-list">
              <li>
                <button type="button" class="category-link active" data-tag="all">
                  <span class="category-name">{translate(locale, 'categories.all')}</span>
                  <span class="category-count">{totalPosts}</span>
                </button>
              </li>
              {categories.map((category: { name: string; count: number }) => (
                <li>
                  <button type="button" class="category-link" data-tag={category.name.toLowerCase()}>
                    <span class="category-name">{category.name}</span>
                    <span class="category-count">{category.count}</span>
                  </button>
                </li>
              ))}
            </ul>
          </aside>

          <div class="posts-main-content">
            <div class="articles-grid">
                {page.data.map((post: any) => (
                    <ArticleCard
                        url={`/${locale}/posts/${post.slug.replace(`${locale}/`, '')}/`}
                        title={post.data.title}
                        description={post.data.description}
                        pubDate={post.data.pubDate}
                        author={post.data.author}
                        image={post.data.image}
                        tags={post.data.tags}
                        locale={locale}
                    />
                ))}
            </div>

            <Pagination
              currentPage={page.currentPage}
              totalPages={page.lastPage}
              baseUrl={`/${locale}/posts/`}
            />
        </div>
      </div>
    </div>
</BaseLayout>

<style>
  .posts-page-container {
    max-width: 1400px;
    margin: 0 auto;
    padding: 2rem;
  }

  .posts-page-header {
    margin-bottom: 2rem;
  }

  .posts-page-header h1 {
    font-size: 2.5rem;
    font-weight: bold;
    color: var(--text-primary);
    margin-bottom: 0.5rem;
  }

  .posts-subtitle {
    font-size: 1rem;
    color: var(--text-secondary);
    margin-bottom: 2rem;
  }

  .posts-layout {
    display: grid;
    grid-template-columns: 280px 1fr;
    gap: 3rem;
    align-items: start;
  }

  .categories-sidebar {
    position: sticky;
    top: 5rem;
  }

  .categories-sidebar h3 {
    font-size: 0.75rem;
    font-weight: 600;
    letter-spacing: 0.1em;
    color: var(--text-muted);
    margin-bottom: 1rem;
    text-transform: uppercase;
  }

  .category-list {
    list-style: none;
    padding: 0;
    margin: 0;
  }

  .category-list li {
    margin-bottom: 0.25rem;
  }

  .category-link {
    display: flex;
    width: 100%;
    justify-content: space-between;
    align-items: center;
    padding: 0.5rem 0.75rem;
    border-radius: 6px;
    text-decoration: none;
    color: var(--text-muted);
    transition: all 0.2s;
    background: none;
    border: none;
    font: inherit;
    cursor: pointer;
  }

  .category-link:hover {
    background: var(--bg-secondary);
    color: var(--text-primary);
  }

  .category-link.active {
    background: var(--bg-secondary);
    color: var(--accent-color);
  }

  .category-count {
    font-size: 0.75rem;
    background: var(--bg-tertiary);
    padding: 0.125rem 0.5rem;
    border-radius: 10px;
  }

  .posts-main-content {
    min-width: 0;
  }

  .articles-grid {
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
    margin-bottom: 3rem;
  }

  @media (max-width: 968px) {
    .posts-layout {
      grid-template-columns: 1fr;
      gap: 2rem;
    }

    .categories-sidebar {
      position: static;
    }
  }

  @media (max-width: 768px) {
    .posts-page-container {
      padding: 1rem;
    }

    .posts-page-header h1 {
      font-size: 2rem;
    }

    .posts-subtitle {
      font-size: 0.9rem;
    }
  }
</style>
